environments:
  istio: &I
    values:
      - ../llm-d/guides/prereq/gateway-provider/common-configurations/istio.yaml
  kgateway: &KG
    values:
      - ../llm-d/guides/prereq/gateway-provider/common-configurations/kgateway.yaml
  default:
    <<: *I

---

{{- $ns := .Namespace | default "tms" -}}
{{- $rn := (env "RELEASE_NAME_POSTFIX") | default "glm-disagg" -}}
{{- $model := env "MODEL" | default "zai-org/GLM-4.7-FP8" -}}
{{- $msValues := env "MS_VALUES" -}}
{{- $decodeTP := env "DECODE_TP" | default "8" -}}
{{- $prefillTP := env "PREFILL_TP" | default "4" -}}

repositories:
  - name: llm-d-modelservice
    url: https://llm-d-incubation.github.io/llm-d-modelservice/
  - name: llm-d-infra
    url: https://llm-d-incubation.github.io/llm-d-infra/

releases:
  - name: {{ printf "infra-%s" $rn | quote }}
    namespace: {{ $ns }}
    chart: llm-d-infra/llm-d-infra
    version: v1.3.6
    installed: true
    labels:
      type: infrastructure
      kind: inference-stack
    values:
      - gateway:
          {{ .Environment.Values.gateway | toYaml | nindent 10 }}

  - name: {{ printf "gaie-%s" $rn | quote }}
    namespace: {{ $ns }}
    chart: oci://registry.k8s.io/gateway-api-inference-extension/charts/inferencepool
    version: v1.3.0
    installed: true
    needs:
      - {{ printf "infra-%s" $rn | quote }}
    values:
      - gaie/values.yaml
    {{- if or (eq .Environment.Name "istio") (eq .Environment.Name "default") }}
      - provider:
          name: {{ .Environment.Values.provider.name }}
          istio:
            {{ .Environment.Values.provider.istio | toYaml | nindent 12 }}
      - provider:
          istio:
            destinationRule:
              host: {{ printf "gaie-%s-epp.%s.svc.cluster.local" $rn $ns | quote }}
      - inferenceExtension:
          flags:
            {{ .Environment.Values.inferenceExtension.flags | toYaml | nindent 12 }}
    {{- end }}
    labels:
      kind: inference-stack

  - name: {{ printf "ms-%s" $rn | quote }}
    namespace: {{ $ns }}
    chart: llm-d-modelservice/llm-d-modelservice
    version: v0.4.5
    installed: true
    needs:
      - {{ printf "infra-%s" $rn | quote }}
      - {{ printf "gaie-%s" $rn | quote }}
    values:
      - ms/values.yaml
    {{- if $msValues }}
      - {{ $msValues }}
    {{- end }}
    {{- if or (eq .Environment.Name "istio") (eq .Environment.Name "default") }}
      - routing:
          {{ .Environment.Values.routing | toYaml | nindent 10 }}
    {{- end }}
    set:
      - name: modelArtifacts.uri
        value: {{ printf "hf://%s" $model | quote }}
      - name: modelArtifacts.name
        value: {{ $model | quote }}
      # NIC count matches TP for GPUDirect RDMA
      - name: decode.containers[0].resources.limits.nvidia\.com/sriov-rdma-vf
        value: {{ $decodeTP | quote }}
      - name: decode.containers[0].resources.requests.nvidia\.com/sriov-rdma-vf
        value: {{ $decodeTP | quote }}
      - name: prefill.containers[0].resources.limits.nvidia\.com/sriov-rdma-vf
        value: {{ $prefillTP | quote }}
      - name: prefill.containers[0].resources.requests.nvidia\.com/sriov-rdma-vf
        value: {{ $prefillTP | quote }}
    labels:
      kind: inference-stack
